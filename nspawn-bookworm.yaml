# debos config file supporting Debian bookworm containers for systemd-nspawn.

# By default this machine expects you'll use macvlan networking.

# Variables for arch, hostname, and upstream Debian mirror.
{{- $arch := or .arch "amd64" }}
{{- $hostname := or .hostname "localhost" }}
{{- $mirror := or .mirror "http://deb.debian.org/debian/" }}

architecture: {{ $arch }}

actions:
  - action: debootstrap
    description: Debootstrap core distro
    suite: "bookworm"
    variant: "minbase"
    components:
      - main
    mirror: {{ $mirror }}

  - action: run
    description: Add security apt repo
    chroot: true
    command: echo deb http://deb.debian.org/debian-security/ bookworm-security main >> /etc/apt/sources.list

  - action: run
    description: Add updates apt repo
    chroot: true
    command: echo deb {{ $mirror }} bookworm-updates main >> /etc/apt/sources.list

  - action: run
    description: Update packages due to security and updates repo adds
    chroot: true
    command: apt-get update && apt-get -y dist-upgrade

  - action: apt
    description: Install expected base packages
    recommends: false
    packages:
      - avahi-daemon
      - ca-certificates
      - dbus
      - iproute2
      - less
      - libnss-mdns
      - libnss-systemd
      - libpam-systemd
      - locales
      - lsb-release
      - openssh-server
      - sudo
      - systemd
      - systemd-resolved
      - vim-tiny

  - action: run
    description: Delete any generated SSH server keys
    chroot: true
    command: rm -vf /etc/ssh/ssh_host*key*

  - action: overlay
    description: Apply system overlay files
    source: overlays/nspawn-bookworm

  - action: run
    description: Enable first-boot.service
    chroot: true
    command: systemctl enable first-boot.service

  - action: run
    description: Enable systemd-networkd
    chroot: true
    command: systemctl enable systemd-networkd.service

  - action: run
    description: Generate en_US.UTF-8 locale
    chroot: true
    command: locale-gen

  - action: run
    description: Set the default hostname
    chroot: true
    command: echo {{ $hostname }} > /etc/hostname

  - action: run
    description: Set the default root password
    chroot: true
    command: echo "root:password" | chpasswd

  - action: run
    description: Clean up the apt downloaded files
    chroot: true
    command: apt-get clean

  - action: pack
    description: Create tarball of filesystem
    file: {{ $arch }}-nspawn-bookworm-{{ $hostname }}.tar.gz
    compression: gz
